---
 - name: Giving Credentials
   hosts: local
   remote_user: root
   become: false
   gather_facts: false
   connection: ssh
   tasks:
    - name: setup a simple load balancer
      ec2_elb_lb:
        name: aws-blog-elb
        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        state: present
        region: us-east-1
        zones:
          - us-east-1a
        listeners:
          - protocol: http
            load_balancer_port: 80
            instance_port: 80
            ssl_certificate_id: "arn:aws:iam::123456789012:server-certificate/company/servercerts/ProdServerCert"
        health_check:
            ping_protocol: http # options are http, https, ssl, tcp
            ping_port: 80
            ping_path: "/index.html" # not required for tcp or ssl
            response_timeout: 5 # seconds
            interval: 30 # seconds
            unhealthy_threshold: 2
            healthy_threshold: 10
   

    - name: add the  webservers to the load balancer
      local_action: ec2_elb
      args:
        vpc_id: vpc-1740e56e
        instance_id: i-0f8578d7f2fb98c2c
        ec2_elbs: aws-blog-elb
        state: present
        region: us-east-1
      with_items: awsblog-webservers.tagged_instances
